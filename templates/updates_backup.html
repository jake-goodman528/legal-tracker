{% extends "base.html" %}

{% block title %}Industry Updates - Short-Term Rental Compliance{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Header Section -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="mb-2">
                        <i class="fas fa-newspaper me-2"></i>
                        Industry Updates
                    </h1>
                    <p class="lead mb-0">
                        Stay informed about regulatory changes, upcoming modifications, and proposed legislation 
                        affecting short-term rental operations.
                    </p>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-primary" onclick="showBookmarkedUpdates()">
                        <i class="fas fa-bookmark me-1"></i>
                        My Bookmarks
                    </button>
                    <button class="btn btn-outline-info" onclick="showReminders()">
                        <i class="fas fa-bell me-1"></i>
                        Reminders
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" id="searchInput" class="form-control" 
                                       placeholder="Search updates by title, description, tags..." 
                                       value="{{ current_search or '' }}">
                                <button class="btn btn-primary" onclick="performSearch()">Search</button>
                            </div>
                        </div>
                    </div>
                    
                    <form method="GET" action="{{ url_for('main.updates') }}" class="row g-3" id="filterForm">
                        <input type="hidden" name="search" id="searchField" value="{{ current_search or '' }}">
                        
                        <div class="col-md-2">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status" onchange="submitFilters()">
                                <option value="">All Statuses</option>
                                {% for status in statuses %}
                                <option value="{{ status }}" {% if current_status == status %}selected{% endif %}>
                                    {{ status }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category" onchange="submitFilters()">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category }}" {% if current_category == category %}selected{% endif %}>
                                    {{ category }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="impact" class="form-label">Impact Level</label>
                            <select class="form-select" id="impact" name="impact" onchange="submitFilters()">
                                <option value="">All Levels</option>
                                {% for impact in impact_levels %}
                                <option value="{{ impact }}" {% if current_impact == impact %}selected{% endif %}>
                                    {{ impact }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="jurisdiction" class="form-label">Jurisdiction</label>
                            <select class="form-select" id="jurisdiction" name="jurisdiction" onchange="submitFilters()">
                                <option value="">All Jurisdictions</option>
                                {% for jurisdiction in jurisdictions %}
                                <option value="{{ jurisdiction }}" {% if current_jurisdiction == jurisdiction %}selected{% endif %}>
                                    {{ jurisdiction }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Filter Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="btn-toolbar" role="toolbar">
                <div class="btn-group me-2" role="group">
                    <button type="button" class="btn btn-outline-danger" onclick="filterByImpact('High')">
                        <i class="fas fa-exclamation-triangle me-1"></i>High Impact
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="filterByStatus('Upcoming')">
                        <i class="fas fa-clock me-1"></i>Upcoming Changes
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="filterByActionRequired(true)">
                        <i class="fas fa-tasks me-1"></i>Action Required
                    </button>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-info" onclick="filterByCategory('Tax Updates')">
                        <i class="fas fa-calculator me-1"></i>Tax Updates
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="filterByCategory('Licensing Changes')">
                        <i class="fas fa-certificate me-1"></i>Licensing
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Updates Results -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <span class="text-muted">
                        Showing {{ updates|length }} update{% if updates|length != 1 %}s{% endif %}
                        {% if current_search or current_status or current_category or current_impact or current_jurisdiction %}
                        (filtered)
                        {% endif %}
                    </span>
                </div>
                <div>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="viewMode" id="timelineView" checked>
                        <label class="btn btn-outline-primary" for="timelineView">
                            <i class="fas fa-timeline me-1"></i>Timeline
                        </label>
                        <input type="radio" class="btn-check" name="viewMode" id="cardView">
                        <label class="btn btn-outline-primary" for="cardView">
                            <i class="fas fa-th-large me-1"></i>Cards
                        </label>
                    </div>
                </div>
            </div>
            
            {% if updates %}
            <div id="updatesContainer">
                {% for update in updates %}
                <div class="update-item card mb-3" data-update-id="{{ update.id }}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-9">
                                <div class="d-flex align-items-center mb-2">
                                    <h5 class="card-title mb-0 me-3">{{ update.title }}</h5>
                                    
                                    <!-- Status Badge -->
                                    <span class="badge me-2
                                        {% if update.status == 'Recent' %}bg-success
                                        {% elif update.status == 'Upcoming' %}bg-warning text-dark
                                        {% else %}bg-info{% endif %}">
                                        {{ update.status }}
                                    </span>
                                    
                                    <!-- Category Badge -->
                                    <span class="badge me-2
                                        {% if update.category == 'Tax Updates' %}bg-primary
                                        {% elif update.category == 'Licensing Changes' %}bg-secondary
                                        {% elif update.category == 'Court Decisions' %}bg-dark
                                        {% elif update.category == 'Industry News' %}bg-light text-dark
                                        {% else %}bg-danger{% endif %}">
                                        {{ update.category }}
                                    </span>
                                    
                                    <!-- Impact Level -->
                                    <span class="badge impact-{{ update.impact_level.lower() }}">
                                        {{ update.impact_level }} Impact
                                    </span>
                                    
                                    <!-- Action Required Indicator -->
                                    {% if update.action_required %}
                                    <span class="badge bg-warning text-dark ms-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>Action Required
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <p class="card-text">{{ update.description }}</p>
                                
                                {% if update.action_required and update.action_description %}
                                <div class="alert alert-warning alert-sm mb-2">
                                    <strong><i class="fas fa-tasks me-1"></i>Action Required:</strong> 
                                    {{ update.action_description }}
                                </div>
                                {% endif %}
                                
                                <div class="update-meta">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                Affects: <strong>{{ update.jurisdiction_affected }}</strong>
                                            </small>
                                            {% if update.property_types != 'Both' %}
                                            <br><small class="text-muted">
                                                <i class="fas fa-building me-1"></i>
                                                Property Type: <strong>{{ update.property_types }}</strong>
                                            </small>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6">
                                            {% if update.effective_date %}
                                            <small class="text-muted">
                                                <i class="fas fa-calendar-check me-1"></i>
                                                Effective: <strong>{{ update.effective_date.strftime('%B %d, %Y') }}</strong>
                                            </small>
                                            {% endif %}
                                            {% if update.deadline_date %}
                                            <br><small class="text-danger">
                                                <i class="fas fa-clock me-1"></i>
                                                Deadline: <strong>{{ update.deadline_date.strftime('%B %d, %Y') }}</strong>
                                            </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                {% if update.get_tags_list() %}
                                <div class="mt-2">
                                    {% for tag in update.get_tags_list() %}
                                    <span class="badge bg-light text-dark me-1">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 text-md-end">
                                <div class="update-date mb-2">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    {{ update.update_date.strftime('%B %d, %Y') }}
                                </div>
                                
                                <div class="update-priority mb-3">
                                    {% if update.priority == 1 %}
                                    <span class="badge bg-danger">High Priority</span>
                                    {% elif update.priority == 2 %}
                                    <span class="badge bg-warning text-dark">Medium Priority</span>
                                    {% else %}
                                    <span class="badge bg-success">Low Priority</span>
                                    {% endif %}
                                </div>
                                
                                <!-- Interactive Buttons -->
                                <div class="update-actions">
                                    <div class="btn-group-vertical w-100" role="group">
                                        <button class="btn btn-sm btn-outline-success mark-read-btn" 
                                                data-update-id="{{ update.id }}"
                                                {% if update_interactions.get(update.id) and update_interactions.get(update.id).is_read %}
                                                style="display: none;"
                                                {% endif %}>
                                            <i class="fas fa-check me-1"></i>Mark Read
                                        </button>
                                        
                                        <button class="btn btn-sm bookmark-btn" 
                                                data-update-id="{{ update.id }}"
                                                {% if update_interactions.get(update.id) and update_interactions.get(update.id).is_bookmarked %}
                                                class="btn btn-sm btn-warning bookmark-btn"
                                                {% else %}
                                                class="btn btn-sm btn-outline-warning bookmark-btn"
                                                {% endif %}>
                                            <i class="fas fa-bookmark me-1"></i>
                                            {% if update_interactions.get(update.id) and update_interactions.get(update.id).is_bookmarked %}
                                            Bookmarked
                                            {% else %}
                                            Bookmark
                                            {% endif %}
                                        </button>
                                        
                                        <button class="btn btn-sm btn-outline-info reminder-btn" 
                                                data-update-id="{{ update.id }}"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#reminderModal">
                                            <i class="fas fa-bell me-1"></i>Remind Me
                                        </button>
                                        
                                        <button class="btn btn-sm btn-outline-primary share-btn" 
                                                data-update-id="{{ update.id }}"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#shareModal">
                                            <i class="fas fa-share me-1"></i>Share
                                        </button>
                                    </div>
                                </div>
                                
                                {% if update.source_url %}
                                <div class="mt-2">
                                    <a href="{{ update.source_url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-external-link-alt me-1"></i>Source
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                <h4>No updates found</h4>
                <p class="text-muted">Try adjusting your filters to see more updates.</p>
                <button class="btn btn-outline-primary" onclick="clearFilters()">Clear Filters</button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Legend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>
                        Legend
                    </h6>
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Status:</h6>
                            <span class="badge bg-success me-2">Recent</span>Changes that have taken effect<br>
                            <span class="badge bg-warning text-dark me-2">Upcoming</span>Changes scheduled to take effect<br>
                            <span class="badge bg-info me-2">Proposed</span>Changes under consideration
                        </div>
                        <div class="col-md-4">
                            <h6>Impact Level:</h6>
                            <span class="badge impact-high me-2">High</span>Significant operational impact<br>
                            <span class="badge impact-medium me-2">Medium</span>Moderate operational impact<br>
                            <span class="badge impact-low me-2">Low</span>Minor operational impact
                        </div>
                        <div class="col-md-4">
                            <h6>Priority:</h6>
                            <span class="badge bg-danger me-2">High</span>Immediate attention required<br>
                            <span class="badge bg-warning text-dark me-2">Medium</span>Plan action within weeks<br>
                            <span class="badge bg-success me-2">Low</span>Monitor for future changes
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reminder Modal -->
<div class="modal fade" id="reminderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reminderForm">
                    <input type="hidden" id="reminderUpdateId">
                    <div class="mb-3">
                        <label for="reminderDate" class="form-label">Reminder Date</label>
                        <input type="date" class="form-control" id="reminderDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="reminderType" class="form-label">Reminder Type</label>
                        <select class="form-select" id="reminderType">
                            <option value="custom">Custom Reminder</option>
                            <option value="deadline">Deadline Reminder</option>
                            <option value="effective_date">Effective Date Reminder</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reminderEmail" class="form-label">Email (optional)</label>
                        <input type="email" class="form-control" id="reminderEmail" 
                               placeholder="your@email.com">
                    </div>
                    <div class="mb-3">
                        <label for="reminderNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="reminderNotes" rows="3" 
                                  placeholder="Add any notes for this reminder..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveReminder()">Set Reminder</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="shareForm">
                    <input type="hidden" id="shareUpdateId">
                    <div class="mb-3">
                        <label for="shareEmail" class="form-label">Email To</label>
                        <input type="email" class="form-control" id="shareEmail" 
                               placeholder="recipient@email.com">
                    </div>
                    <div class="mb-3">
                        <label for="shareMessage" class="form-label">Personal Message</label>
                        <textarea class="form-control" id="shareMessage" rows="3" 
                                  placeholder="Add a personal message..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Share Content Preview:</label>
                        <div id="sharePreview" class="border rounded p-3 bg-light">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="shareUpdate()">Share</button>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript for enhanced updates functionality
$(document).ready(function() {
    // Search functionality
    $('#searchInput').on('keypress', function(e) {
        if (e.which == 13) {
            performSearch();
        }
    });
    
    // Mark as read functionality
    $('.mark-read-btn').on('click', function() {
        const updateId = $(this).data('update-id');
        markAsRead(updateId, this);
    });
    
    // Bookmark functionality
    $('.bookmark-btn').on('click', function() {
        const updateId = $(this).data('update-id');
        toggleBookmark(updateId, this);
    });
    
    // Reminder modal setup
    $('.reminder-btn').on('click', function() {
        const updateId = $(this).data('update-id');
        $('#reminderUpdateId').val(updateId);
    });
    
    // Share modal setup
    $('.share-btn').on('click', function() {
        const updateId = $(this).data('update-id');
        $('#shareUpdateId').val(updateId);
        generateSharePreview(updateId);
    });
});

function performSearch() {
    const searchTerm = $('#searchInput').val();
    $('#searchField').val(searchTerm);
    $('#filterForm').submit();
}

function submitFilters() {
    const searchTerm = $('#searchInput').val();
    $('#searchField').val(searchTerm);
    $('#filterForm').submit();
}

function clearFilters() {
    $('#searchInput').val('');
    $('#filterForm')[0].reset();
                            window.location.href = "{{ url_for('main.updates') }}";
}

function filterByImpact(impact) {
    $('#impact').val(impact);
    submitFilters();
}

function filterByStatus(status) {
    $('#status').val(status);
    submitFilters();
}

function filterByCategory(category) {
    $('#category').val(category);
    submitFilters();
}

function filterByActionRequired(required) {
    // This would need additional backend support
    // For now, just show high priority items
    filterByImpact('High');
}

function markAsRead(updateId, button) {
    $.post(`/api/updates/${updateId}/mark-read`)
        .done(function(response) {
            if (response.success) {
                $(button).fadeOut();
                showToast('Update marked as read', 'success');
            }
        })
        .fail(function() {
            showToast('Failed to mark as read', 'error');
        });
}

function toggleBookmark(updateId, button) {
    $.post(`/api/updates/${updateId}/bookmark`)
        .done(function(response) {
            if (response.success) {
                if (response.bookmarked) {
                    $(button).removeClass('btn-outline-warning').addClass('btn-warning');
                    $(button).html('<i class="fas fa-bookmark me-1"></i>Bookmarked');
                    showToast('Update bookmarked', 'success');
                } else {
                    $(button).removeClass('btn-warning').addClass('btn-outline-warning');
                    $(button).html('<i class="fas fa-bookmark me-1"></i>Bookmark');
                    showToast('Bookmark removed', 'info');
                }
            }
        })
        .fail(function() {
            showToast('Failed to update bookmark', 'error');
        });
}

function saveReminder() {
    const updateId = $('#reminderUpdateId').val();
    const reminderDate = $('#reminderDate').val();
    const reminderType = $('#reminderType').val();
    const email = $('#reminderEmail').val();
    const notes = $('#reminderNotes').val();
    
    if (!reminderDate) {
        showToast('Please select a reminder date', 'error');
        return;
    }
    
    const data = {
        reminder_date: reminderDate,
        reminder_type: reminderType,
        email: email,
        notes: notes
    };
    
    $.post(`/api/updates/${updateId}/reminder`, JSON.stringify(data), 'json')
        .done(function(response) {
            if (response.success) {
                $('#reminderModal').modal('hide');
                showToast('Reminder set successfully', 'success');
                // Reset form
                $('#reminderForm')[0].reset();
            }
        })
        .fail(function() {
            showToast('Failed to set reminder', 'error');
        });
}

function generateSharePreview(updateId) {
    const data = {
        email: '',
        message: ''
    };
    
    $.post(`/api/updates/${updateId}/share`, JSON.stringify(data), 'json')
        .done(function(response) {
            if (response.success) {
                $('#sharePreview').html(`
                    <strong>Subject:</strong> ${response.share_content.subject}<br>
                    <strong>Content:</strong><br>
                    <pre style="white-space: pre-wrap; font-family: inherit;">${response.share_content.body}</pre>
                `);
            }
        });
}

function shareUpdate() {
    const updateId = $('#shareUpdateId').val();
    const email = $('#shareEmail').val();
    const message = $('#shareMessage').val();
    
    const data = {
        email: email,
        message: message
    };
    
    $.post(`/api/updates/${updateId}/share`, JSON.stringify(data), 'json')
        .done(function(response) {
            if (response.success) {
                // Copy to clipboard
                navigator.clipboard.writeText(response.share_content.body);
                $('#shareModal').modal('hide');
                showToast('Share content copied to clipboard', 'success');
                // Reset form
                $('#shareForm')[0].reset();
            }
        })
        .fail(function() {
            showToast('Failed to generate share content', 'error');
        });
}

function showBookmarkedUpdates() {
    $.get('/api/updates/bookmarked')
        .done(function(response) {
            if (response.success) {
                // You could show bookmarked updates in a modal or redirect to filtered view
                                        window.location.href = "{{ url_for('main.updates') }}?bookmarked=true";
            }
        });
}

function showReminders() {
    $.get('/api/updates/reminders')
        .done(function(response) {
            if (response.success) {
                // Show reminders in a modal or redirect to reminders page
                alert(`You have ${response.count} active reminders`);
            }
        });
}

function showToast(message, type) {
    // Simple toast notification
    const toastClass = type === 'error' ? 'bg-danger' : type === 'success' ? 'bg-success' : 'bg-info';
    const toast = $(`
        <div class="toast position-fixed top-0 end-0 m-3 ${toastClass} text-white" role="alert" style="z-index: 9999;">
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `);
    
    $('body').append(toast);
    toast.fadeIn().delay(3000).fadeOut(function() {
        $(this).remove();
    });
}
</script>

<style>
.impact-high {
    background-color: #dc3545 !important;
    color: white !important;
}

.impact-medium {
    background-color: #fd7e14 !important;
    color: white !important;
}

.impact-low {
    background-color: #198754 !important;
    color: white !important;
}

.update-item {
    transition: all 0.3s ease;
}

.update-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.alert-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.update-actions .btn {
    margin-bottom: 0.25rem;
}

.btn-group-vertical .btn:not(:last-child) {
    border-bottom: 0;
}

.toast {
    min-width: 250px;
}

@media print {
    .update-actions,
    .card .btn,
    .btn-toolbar,
    .modal {
        display: none !important;
    }
}
</style>
{% endblock %}
