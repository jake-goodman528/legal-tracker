{% extends "admin/admin_base.html" %}

{% block title %}{{ title }} - Admin{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="admin-form-title">
                    <i class="fas fa-book me-2"></i>
                    {{ title }}
                </h1>
                <a href="{{ url_for('admin.manage_regulations') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Back to Regulations
                </a>
            </div>

            <div class="admin-form-container">
                <form method="POST" id="regulationForm">
                    {{ form.hidden_tag() }}
                    
                    <!-- Section 1: Core Information -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fas fa-info-circle me-2"></i>
                                Core Information
                            </h3>
                            <p class="section-description">Basic regulation details and jurisdiction information</p>
                        </div>
                        
                        <div class="section-content">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-4">
                                        {{ form.jurisdiction.label(class="form-label required") }}
                                        {{ form.jurisdiction(class="form-control form-control-lg") }}
                                        {% if form.jurisdiction.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.jurisdiction.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {{ form.jurisdiction.description }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-4">
                                        {{ form.jurisdiction_level.label(class="form-label required") }}
                                        {{ form.jurisdiction_level(class="form-select form-control-lg", id="jurisdictionLevelSelect") }}
                                        {% if form.jurisdiction_level.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.jurisdiction_level.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {{ form.jurisdiction_level.description }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-4">
                                        {{ form.location.label(class="form-label required") }}
                                        {{ form.location(class="form-select form-control-lg", id="locationSelect") }}
                                        {% if form.location.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.location.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {{ form.location.description }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                {{ form.title.label(class="form-label required") }}
                                {{ form.title(class="form-control form-control-lg") }}
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.title.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ form.title.description }}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                {{ form.last_updated.label(class="form-label") }}
                                {{ form.last_updated(class="form-control", type="date") }}
                                {% if form.last_updated.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.last_updated.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ form.last_updated.description }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Rich Text Content -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fas fa-file-text me-2"></i>
                                Regulation Content
                            </h3>
                            <p class="section-description">Detailed content sections with rich text formatting support</p>
                        </div>
                        
                        <div class="section-content">
                            <div class="mb-4">
                                {{ form.overview.label(class="form-label") }}
                                {{ form.overview(class="form-control rich-text-editor") }}
                                {% if form.overview.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.overview.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ form.overview.description }}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                {{ form.detailed_requirements.label(class="form-label") }}
                                {{ form.detailed_requirements(class="form-control rich-text-editor") }}
                                {% if form.detailed_requirements.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.detailed_requirements.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ form.detailed_requirements.description }}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                {{ form.compliance_steps.label(class="form-label") }}
                                {{ form.compliance_steps(class="form-control rich-text-editor") }}
                                {% if form.compliance_steps.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.compliance_steps.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ form.compliance_steps.description }}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                {{ form.required_forms.label(class="form-label") }}
                                {{ form.required_forms(class="form-control rich-text-editor") }}
                                {% if form.required_forms.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.required_forms.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ form.required_forms.description }}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                {{ form.penalties_non_compliance.label(class="form-label") }}
                                {{ form.penalties_non_compliance(class="form-control rich-text-editor") }}
                                {% if form.penalties_non_compliance.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.penalties_non_compliance.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ form.penalties_non_compliance.description }}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                {{ form.recent_changes.label(class="form-label") }}
                                {{ form.recent_changes(class="form-control rich-text-editor") }}
                                {% if form.recent_changes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.recent_changes.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ form.recent_changes.description }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-actions">
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin.manage_regulations') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>Save Regulation
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Rich Text Editor Styles -->
<style>
.rich-text-toolbar {
    border: 1px solid #dee2e6;
    border-bottom: none;
    padding: 8px;
    background-color: #f8f9fa;
    border-radius: 0.375rem 0.375rem 0 0;
}

.rich-text-toolbar button {
    border: none;
    background: none;
    padding: 4px 8px;
    margin-right: 4px;
    border-radius: 3px;
    font-size: 12px;
    cursor: pointer;
}

.rich-text-toolbar button:hover {
    background-color: #e9ecef;
}

.rich-text-editor[contenteditable="true"] {
    border: 1px solid #dee2e6;
    border-top: none;
    padding: 12px;
    min-height: 120px;
    border-radius: 0 0 0.375rem 0.375rem;
    background-color: white;
}

.rich-text-editor[contenteditable="true"]:focus {
    outline: none;
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.admin-form-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 2rem;
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e9ecef;
}

.form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
}

.section-header {
    margin-bottom: 1.5rem;
}

.section-title {
    color: #2c3e50;
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.section-description {
    color: #6c757d;
    margin-bottom: 0;
    font-size: 0.95rem;
}

.form-actions {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
}

.btn-loading {
    position: relative;
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Convert textareas to rich text editors
    const textareas = document.querySelectorAll('.rich-text-editor');
    
    textareas.forEach(function(textarea) {
        // Create toolbar
        const toolbar = document.createElement('div');
        toolbar.className = 'rich-text-toolbar';
        toolbar.innerHTML = `
            <button type="button" onclick="formatText(this, 'bold')" title="Bold"><b>B</b></button>
            <button type="button" onclick="formatText(this, 'italic')" title="Italic"><i>I</i></button>
            <button type="button" onclick="formatText(this, 'underline')" title="Underline"><u>U</u></button>
            <button type="button" onclick="formatText(this, 'insertUnorderedList')" title="Bullet List">• List</button>
            <button type="button" onclick="formatText(this, 'insertOrderedList')" title="Numbered List">1. List</button>
            <button type="button" onclick="formatText(this, 'indent')" title="Indent">→</button>
            <button type="button" onclick="formatText(this, 'outdent')" title="Outdent">←</button>
        `;
        
        // Create contenteditable div
        const editor = document.createElement('div');
        editor.className = 'rich-text-editor';
        editor.contentEditable = true;
        editor.innerHTML = textarea.value || '';
        editor.setAttribute('data-textarea', textarea.id);
        
        // Insert toolbar and editor
        textarea.parentNode.insertBefore(toolbar, textarea);
        textarea.parentNode.insertBefore(editor, textarea);
        textarea.style.display = 'none';
        
        // Update textarea when content changes
        editor.addEventListener('input', function() {
            textarea.value = editor.innerHTML;
        });
        
        // Update on form submit
        const form = textarea.closest('form');
        if (form) {
            form.addEventListener('submit', function() {
                textarea.value = editor.innerHTML;
            });
        }
    });
    
    // Global formatting function
    window.formatText = function(button, command) {
        const toolbar = button.parentNode;
        const editor = toolbar.nextElementSibling;
        editor.focus();
        document.execCommand(command, false, null);
        
        // Update the corresponding textarea
        const textareaId = editor.getAttribute('data-textarea');
        const textarea = document.getElementById(textareaId);
        if (textarea) {
            textarea.value = editor.innerHTML;
        }
    }
    
    // Form validation and loading state
    const form = document.getElementById('regulationForm');
    const submitButton = form.querySelector('button[type="submit"]');
    
    form.addEventListener('submit', function(e) {
        // Save all rich text content before form submission
        const editors = document.querySelectorAll('.rich-text-editor[contenteditable="true"]');
        editors.forEach(function(editor) {
            const textareaId = editor.getAttribute('data-textarea');
            const textarea = document.getElementById(textareaId);
            if (textarea) {
                textarea.value = editor.innerHTML;
            }
        });
        
        // Add loading state to submit button
        submitButton.classList.add('btn-loading');
        submitButton.disabled = true;
    });
    
    // Dynamic location filtering based on jurisdiction level
    const jurisdictionLevelSelect = document.getElementById('jurisdictionLevelSelect');
    const locationSelect = document.getElementById('locationSelect');
    
    if (jurisdictionLevelSelect && locationSelect) {
        jurisdictionLevelSelect.addEventListener('change', function() {
            const jurisdictionLevel = this.value;
            
            // Clear current options
            locationSelect.innerHTML = '<option value="">Loading...</option>';
            
            if (jurisdictionLevel) {
                // Fetch location options from API
                fetch(`/api/locations/${jurisdictionLevel}`)
                    .then(response => response.json())
                    .then(data => {
                        locationSelect.innerHTML = '<option value="">Select Location</option>';
                        if (data.success && data.locations) {
                            data.locations.forEach(location => {
                                const option = document.createElement('option');
                                option.value = location;
                                option.textContent = location;
                                locationSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching locations:', error);
                        locationSelect.innerHTML = '<option value="">Error loading locations</option>';
                    });
            } else {
                locationSelect.innerHTML = '<option value="">Select Jurisdiction Level First</option>';
            }
        });
        
        // Initialize location options if jurisdiction level is already selected
        if (jurisdictionLevelSelect.value) {
            jurisdictionLevelSelect.dispatchEvent(new Event('change'));
        }
    }
});
</script>
{% endblock %}
